<!DOCTYPE html><html><head>
      <title>readme</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:///c:\Users\Lenovo\.vscode\extensions\shd101wyy.markdown-preview-enhanced-0.8.0\crossnote\dependencies\katex\katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}

      </style>
      </head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      <h1 id="portfolio-optimization-using-deep-reinforcement-learning">Portfolio Optimization using deep Reinforcement Learning. </h1>
<h2 id="part-one-creating-the-environment">Part One: Creating the environment. </h2>
<h3 id="a-creating-the-data-provider">a) creating the data provider </h3>
<p>the data provider is a class that will provide the data to the environment. It will be used to get the data from the database, and to preprocess it.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">DataSrc</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""This class is used by the Environment class to get the data for each new episode. It is not used directly by the agent."""</span>
    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> df<span class="token punctuation">,</span> steps<span class="token operator">=</span><span class="token number">252</span><span class="token punctuation">,</span> scale<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> scale_extra_cols<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> augment<span class="token operator">=</span><span class="token number">0.00</span><span class="token punctuation">,</span> window_length<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> random_reset<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>prevent_overfitting<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Parameters
        ----------
        data : pd.DataFrame
            Data for the episode.
            csv for data frame index of timestamps and multi-index columns levels=[['BTC'],...],['open','low','high','close',...]]
        steps : int
            Number of steps for the episode.
        scale : bool
            Whether to scale the data or not.
        scale_extra_cols : bool
            Whether to scale extra columns or not.
        augment : float
            Noise to add to the data.
        window_length : int
            Size of the observation window.
        random_reset : bool
            Whether to reset randomly or not.
        prevent_overfitting : bool
            Whether to augment data or not.
        """</span>
        self<span class="token punctuation">.</span>df <span class="token operator">=</span> df
        self<span class="token punctuation">.</span>steps <span class="token operator">=</span> steps<span class="token operator">+</span> <span class="token number">1</span>
        self<span class="token punctuation">.</span>scale <span class="token operator">=</span> scale
        self<span class="token punctuation">.</span>scale_extra_cols <span class="token operator">=</span> scale_extra_cols
        self<span class="token punctuation">.</span>augment <span class="token operator">=</span> augment
        self<span class="token punctuation">.</span>window_length <span class="token operator">=</span> window_length
        self<span class="token punctuation">.</span>idx <span class="token operator">=</span> self<span class="token punctuation">.</span>window_length<span class="token operator">+</span><span class="token number">1</span>
        self<span class="token punctuation">.</span>random_reset <span class="token operator">=</span> random_reset
        self<span class="token punctuation">.</span>prevent_overfitting <span class="token operator">=</span> prevent_overfitting
              <span class="token comment"># get rid of NaN's</span>
        df <span class="token operator">=</span> df<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
        df<span class="token punctuation">.</span>replace<span class="token punctuation">(</span>np<span class="token punctuation">.</span>nan<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        df <span class="token operator">=</span> df<span class="token punctuation">.</span>fillna<span class="token punctuation">(</span>method<span class="token operator">=</span><span class="token string">"pad"</span><span class="token punctuation">)</span>

        <span class="token comment"># dataframe to matrix</span>
        self<span class="token punctuation">.</span>asset_names <span class="token operator">=</span> df<span class="token punctuation">.</span>columns<span class="token punctuation">.</span>levels<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>features <span class="token operator">=</span> df<span class="token punctuation">.</span>columns<span class="token punctuation">.</span>levels<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>price_columns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">,</span> <span class="token string">'high'</span><span class="token punctuation">,</span> <span class="token string">'low'</span><span class="token punctuation">]</span>
        data <span class="token operator">=</span> df<span class="token punctuation">.</span>to_numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>
            <span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>df<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>asset_names<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>price_columns<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_data <span class="token operator">=</span> np<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_times <span class="token operator">=</span> df<span class="token punctuation">.</span>index

        self<span class="token punctuation">.</span>non_price_columns <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span>
            df<span class="token punctuation">.</span>columns<span class="token punctuation">.</span>levels<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token builtin">set</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>price_columns<span class="token punctuation">)</span>
        
        <span class="token comment"># Stats to let us normalize non price columns</span>
        <span class="token comment"># To be added </span>

        self<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">_step</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""this function is called at each step of the episode it takes the data for the current step and returns the history matrix, the price relative vector and a boolean indicating if the episode is done or not"""</span>
        <span class="token comment"># get history matrix from dataframe</span>

        data_window <span class="token operator">=</span> self<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>step<span class="token punctuation">:</span>self<span class="token punctuation">.</span>step <span class="token operator">+</span>
                                self<span class="token punctuation">.</span>window_length<span class="token punctuation">]</span><span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"step: "</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>step <span class="token punctuation">)</span> <span class="token keyword keyword-if">if</span> self<span class="token punctuation">.</span>step<span class="token operator">%</span><span class="token number">500</span><span class="token operator">==</span><span class="token number">0</span> <span class="token keyword keyword-else">else</span> <span class="token boolean">None</span>
        <span class="token comment"># (eq.1) prices</span>
        y1 <span class="token operator">=</span> data_window<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token punctuation">(</span>data_window<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span> eps<span class="token punctuation">)</span>
        y1<span class="token operator">=</span>np<span class="token punctuation">.</span>nan_to_num<span class="token punctuation">(</span>y1<span class="token punctuation">)</span>
        y1<span class="token operator">=</span>np<span class="token punctuation">.</span>insert<span class="token punctuation">(</span>y1<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span>

        <span class="token comment"># (eq 18) X: prices are divided by close price</span>
        nb_pc <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>price_columns<span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> self<span class="token punctuation">.</span>scale<span class="token punctuation">:</span>
            last_price_vect <span class="token operator">=</span> data_window<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
            data_window<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">/=</span> last_price_vect<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span>
                                                          np<span class="token punctuation">.</span>newaxis<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">+</span> eps
        data_window<span class="token operator">=</span>np<span class="token punctuation">.</span>nan_to_num<span class="token punctuation">(</span>data_window<span class="token punctuation">)</span>


        self<span class="token punctuation">.</span>step <span class="token operator">+=</span> <span class="token number">1</span>
        history <span class="token operator">=</span> data_window
        history<span class="token operator">=</span> history<span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        done <span class="token operator">=</span> <span class="token builtin">bool</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>step <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>steps<span class="token punctuation">)</span>

        <span class="token keyword keyword-return">return</span> history<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> done
    
    <span class="token keyword keyword-def">def</span> <span class="token function">reset</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""this function is called at the beginning of each episode it resets the data and returns the history matrix, the price relative vector and a boolean indicating if the episode is done or not"""</span>
        self<span class="token punctuation">.</span>step <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"reseting data"</span><span class="token punctuation">)</span>
        <span class="token comment"># get data for this episode</span>
        <span class="token keyword keyword-if">if</span> self<span class="token punctuation">.</span>random_reset<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>idx <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span>
                low<span class="token operator">=</span>self<span class="token punctuation">.</span>window_length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> high<span class="token operator">=</span>self<span class="token punctuation">.</span>_data<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>steps <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
            <span class="token comment"># continue sequentially, before reseting to start</span>
            <span class="token keyword keyword-if">if</span> self<span class="token punctuation">.</span>idx<span class="token operator">&gt;</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_data<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>steps <span class="token operator">-</span> self<span class="token punctuation">.</span>window_length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>idx<span class="token operator">=</span>self<span class="token punctuation">.</span>window_length <span class="token operator">+</span> <span class="token number">1</span>
            <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>idx <span class="token operator">+=</span> self<span class="token punctuation">.</span>steps
        data <span class="token operator">=</span> self<span class="token punctuation">.</span>_data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>idx <span class="token operator">-</span>
                          self<span class="token punctuation">.</span>window_length<span class="token punctuation">:</span>self<span class="token punctuation">.</span>idx <span class="token operator">+</span> self<span class="token punctuation">.</span>steps <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>times <span class="token operator">=</span> self<span class="token punctuation">.</span>_times<span class="token punctuation">[</span>self<span class="token punctuation">.</span>idx <span class="token operator">-</span>
                                 self<span class="token punctuation">.</span>window_length<span class="token punctuation">:</span>self<span class="token punctuation">.</span>idx <span class="token operator">+</span> self<span class="token punctuation">.</span>steps <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span>

        <span class="token keyword keyword-if">if</span> self<span class="token punctuation">.</span>prevent_overfitting<span class="token punctuation">:</span>   
        <span class="token comment"># augment data to prevent overfitting</span>
            data <span class="token operator">+=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>normal<span class="token punctuation">(</span>loc<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> scale<span class="token operator">=</span>self<span class="token punctuation">.</span>augment<span class="token punctuation">,</span> size<span class="token operator">=</span>data<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>data <span class="token operator">=</span> data
        <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"idx: "</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>idx<span class="token punctuation">)</span>
</code></pre><p>the init function takes data and other parameters, transforms it to a matrix and stores it in self._data, then calls for the reset function.</p>
<p>the reset function is called at the beginning of each episode,it takes the data, takes a chunk of it (containing all the necessary data for the entire episode(steps+history)),augments it if enabled and stores it in self.data.</p>
<p>the _step function activates each step, it takes data and returns the y1 vector which is the latest price relative fluctuations, the history matrix and a boolean indicating if the episode is done or not.</p>
<p><img src="readme_images%5Cselfdotdata.png" alt="self.data"></p>
<blockquote>
<p>this image shows how history is extracted from self.data at each step</p>
</blockquote>
<p><img src="readme_images%5Cclassdatasrc.png" alt="self.data"></p>
<blockquote>
<p>this image shows the inputs and outputs of the class.</p>
</blockquote>
<h3 id="b-creating-the-portfolio-simulator">b) creating the portfolio simulator </h3>
<p>the portfolio simulator is a class that will simulate the portfolio, it will be used to calculate the reward and the portfolio value.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">PortfolioSim</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""this class is used by the Environment class to simulate the portfolio. It is not used directly by the agent."""</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> asset_names<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> steps<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">,</span> trading_cost<span class="token operator">=</span><span class="token number">0.0025</span><span class="token punctuation">,</span> time_cost<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>cost <span class="token operator">=</span> trading_cost
        self<span class="token punctuation">.</span>time_cost <span class="token operator">=</span> time_cost
        self<span class="token punctuation">.</span>steps <span class="token operator">=</span> steps
        self<span class="token punctuation">.</span>asset_names <span class="token operator">=</span> asset_names
        self<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">_step</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> w1<span class="token punctuation">,</span> y1<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Step.
        it takes the portfolio weights and the price relative vector and returns the reward, the info dictionary and a boolean indicating if the episode is done or not
        
        w1 - new action of portfolio weights - e.g. [0.1,0.9, 0.0]
        y1 - price relative vector also called return
            e.g. [1.0, 0.9, 1.1]
        Numbered equations are from https://arxiv.org/abs/1706.10059
        """</span>
        w0 <span class="token operator">=</span> self<span class="token punctuation">.</span>w0
        p0 <span class="token operator">=</span> self<span class="token punctuation">.</span>p0

        dw1 <span class="token operator">=</span> <span class="token punctuation">(</span>y1 <span class="token operator">*</span> w0<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>np<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>y1<span class="token punctuation">,</span> w0<span class="token punctuation">)</span> <span class="token operator">+</span> eps<span class="token punctuation">)</span>  <span class="token comment"># (eq7) weights evolve into</span>

        <span class="token comment"># (eq16) cost to change portfolio</span>
        <span class="token comment"># (excluding change in cash to avoid double counting for transaction cost)</span>
        c1 <span class="token operator">=</span> self<span class="token punctuation">.</span>cost <span class="token operator">*</span> <span class="token punctuation">(</span>
            np<span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span>dw1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">-</span> w1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        p1 <span class="token operator">=</span> p0 <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> c1<span class="token punctuation">)</span> <span class="token operator">*</span> np<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>y1<span class="token punctuation">,</span> w0<span class="token punctuation">)</span>  <span class="token comment"># (eq11) final portfolio value</span>

        p1 <span class="token operator">=</span> p1 <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>time_cost<span class="token punctuation">)</span>  <span class="token comment"># we can add a cost to holding</span>

        <span class="token comment"># can't have negative holdings in this model (no shorts)</span>
        p1 <span class="token operator">=</span> np<span class="token punctuation">.</span>clip<span class="token punctuation">(</span>p1<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>inf<span class="token punctuation">)</span>

        rho1 <span class="token operator">=</span> p1 <span class="token operator">/</span> p0 <span class="token operator">-</span> <span class="token number">1</span>  <span class="token comment"># rate of returns</span>
        r1 <span class="token operator">=</span> np<span class="token punctuation">.</span>log<span class="token punctuation">(</span><span class="token punctuation">(</span>p1 <span class="token operator">+</span> eps<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>p0 <span class="token operator">+</span> eps<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># (eq10) log rate of return</span>
        <span class="token comment"># (eq22) immediate reward is log rate of return scaled by episode length</span>
        reward <span class="token operator">=</span> r1 <span class="token operator">/</span> self<span class="token punctuation">.</span>steps

        <span class="token comment"># remember for next step</span>
        self<span class="token punctuation">.</span>w0 <span class="token operator">=</span> w1
        self<span class="token punctuation">.</span>p0 <span class="token operator">=</span> p1

        <span class="token comment"># if we run out of money, we're done</span>
        done <span class="token operator">=</span> math<span class="token punctuation">.</span>isclose<span class="token punctuation">(</span>p1<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>rel_tol<span class="token operator">=</span><span class="token number">1e-03</span><span class="token punctuation">,</span> abs_tol<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">)</span>

        <span class="token comment"># should only return single values, not list</span>
        info <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">"reward"</span><span class="token punctuation">:</span> reward<span class="token punctuation">,</span>
            <span class="token string">"log_return"</span><span class="token punctuation">:</span> r1<span class="token punctuation">,</span>
            <span class="token string">"portfolio_value"</span><span class="token punctuation">:</span> p1<span class="token punctuation">,</span>
            <span class="token string">"market_return"</span><span class="token punctuation">:</span> y1<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"rate_of_return"</span><span class="token punctuation">:</span> rho1<span class="token punctuation">,</span>
            <span class="token string">"weights_mean"</span><span class="token punctuation">:</span> w1<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"weights_std"</span><span class="token punctuation">:</span> w1<span class="token punctuation">.</span>std<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"cost"</span><span class="token punctuation">:</span> c1<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
        <span class="token comment"># record weights and prices</span>
        <span class="token keyword keyword-for">for</span> i<span class="token punctuation">,</span> name <span class="token keyword keyword-in">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'Capital'</span><span class="token punctuation">]</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>asset_names<span class="token punctuation">)</span><span class="token punctuation">:</span>
            info<span class="token punctuation">[</span><span class="token string">'weight_'</span> <span class="token operator">+</span> name<span class="token punctuation">]</span> <span class="token operator">=</span> w1<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            info<span class="token punctuation">[</span><span class="token string">'price_'</span> <span class="token operator">+</span> name<span class="token punctuation">]</span> <span class="token operator">=</span> y1<span class="token punctuation">[</span>i<span class="token punctuation">]</span>

        self<span class="token punctuation">.</span>infos<span class="token punctuation">.</span>append<span class="token punctuation">(</span>info<span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> reward<span class="token punctuation">,</span> info<span class="token punctuation">,</span> done

    <span class="token keyword keyword-def">def</span> <span class="token function">reset</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>infos <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>w0 <span class="token operator">=</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span> <span class="token punctuation">[</span><span class="token number">1.0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token number">0.0</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>asset_names<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>w0<span class="token operator">=</span> self<span class="token punctuation">.</span>w0<span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>p0 <span class="token operator">=</span> <span class="token number">1.0</span>

</code></pre><p>the init function takes the asset names, the number of steps, the trading cost and the time cost. then calls for the reset function.</p>
<p>the reset function resets the portfolio to the initial state. which is 1 btc and 0 of the other assets.</p>
<p>the _step function takes the new weights I allocated to each assets, checks the price fluctuations and calculates the reward and the portfolio value. if the portfolio value is 0 aka we ran out of money then the episode is done.</p>
<p><img src="readme_images%5Cportfoliosim.png" alt="self.data"></p>
<blockquote>
<p>this image shows the inputs and outputs of the class portfoliosim</p>
</blockquote>
<h3 id="c-creating-the-environment">c) creating the environment </h3>
<p>the environment is a class that will be used by the agent to interact with the data provider and the portfolio simulator.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">PortfolioEnv</span><span class="token punctuation">(</span>gym<span class="token punctuation">.</span>Env<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    An environment for financial portfolio management.

    Financial portfolio management is the process of constant redistribution of a fund into different
    financial products.

    Based on [Jiang 2017](https://arxiv.org/abs/1706.10059)
    """</span>

    metadata <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'render.modes'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'notebook'</span><span class="token punctuation">,</span> <span class="token string">'ansi'</span><span class="token punctuation">]</span><span class="token punctuation">}</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                 df<span class="token punctuation">,</span>
                 steps<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>
                 trading_cost<span class="token operator">=</span><span class="token number">0.0025</span><span class="token punctuation">,</span>
                 time_cost<span class="token operator">=</span><span class="token number">0.00</span><span class="token punctuation">,</span>
                 window_length<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span>
                 augment<span class="token operator">=</span><span class="token number">0.00</span><span class="token punctuation">,</span>
                 output_mode<span class="token operator">=</span><span class="token string">'EIIE'</span><span class="token punctuation">,</span>
                 log_dir<span class="token operator">=</span>log_dir<span class="token punctuation">,</span>
                 scale<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                 scale_extra_cols<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                 random_reset<span class="token operator">=</span><span class="token boolean">True</span>
                 <span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        An environment for financial portfolio management.

        Params:
            df - csv for data frame index of timestamps
                 and multi-index columns levels=[['LTCBTC'],...],['open','low','high','close']]
            steps - steps in episode
            window_length - how many past observations["history"] to return
            trading_cost - cost of trade as a fraction,  e.g. 0.0025 corresponding to max rate of 0.25% at Poloniex (2017)
            time_cost - cost of holding as a fraction
            augment - fraction to randomly shift data by
            output_mode: decides observation["history"] shape
            - 'EIIE' for (assets, window, 3)
            - 'atari' for (window, window, 3) (assets is padded)
            - 'mlp' for (assets*window*3)
            log_dir: directory to save plots to
            scale - scales price data by last opening price on each episode (except return)
            scale_extra_cols - scales non price data using mean and std for whole dataset
        """</span>
        self<span class="token punctuation">.</span>src <span class="token operator">=</span> DataSrc<span class="token punctuation">(</span>df<span class="token operator">=</span>df<span class="token punctuation">,</span> steps<span class="token operator">=</span>steps<span class="token punctuation">,</span> scale<span class="token operator">=</span>scale<span class="token punctuation">,</span> scale_extra_cols<span class="token operator">=</span>scale_extra_cols<span class="token punctuation">,</span>
                           augment<span class="token operator">=</span>augment<span class="token punctuation">,</span> window_length<span class="token operator">=</span>window_length<span class="token punctuation">,</span>
                           random_reset<span class="token operator">=</span>random_reset<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_plot <span class="token operator">=</span> self<span class="token punctuation">.</span>_plot2 <span class="token operator">=</span> self<span class="token punctuation">.</span>_plot3 <span class="token operator">=</span> self<span class="token punctuation">.</span>_plot4 <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>output_mode <span class="token operator">=</span> output_mode
        self<span class="token punctuation">.</span>sim <span class="token operator">=</span> PortfolioSim<span class="token punctuation">(</span>
            asset_names<span class="token operator">=</span>self<span class="token punctuation">.</span>src<span class="token punctuation">.</span>asset_names<span class="token punctuation">,</span>
            trading_cost<span class="token operator">=</span>trading_cost<span class="token punctuation">,</span>
            time_cost<span class="token operator">=</span>time_cost<span class="token punctuation">,</span>
            steps<span class="token operator">=</span>steps<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>log_dir <span class="token operator">=</span> log_dir

        <span class="token comment"># openai gym attributes</span>
        <span class="token comment"># action will be the portfolio weights [cash_bias,w1,w2...] where wn are [0, 1] for each asset</span>
        nb_assets <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>src<span class="token punctuation">.</span>asset_names<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>action_space <span class="token operator">=</span> gym<span class="token punctuation">.</span>spaces<span class="token punctuation">.</span>Box<span class="token punctuation">(</span>
            <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> shape<span class="token operator">=</span><span class="token punctuation">(</span>nb_assets <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># get the history space from the data min and max</span>
        <span class="token keyword keyword-if">if</span> output_mode <span class="token operator">==</span> <span class="token string">'EIIE'</span><span class="token punctuation">:</span>
            obs_shape <span class="token operator">=</span> <span class="token punctuation">(</span>
                nb_assets<span class="token punctuation">,</span>
                window_length<span class="token punctuation">,</span>
                <span class="token number">3</span>
            <span class="token punctuation">)</span>
        <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-raise">raise</span> Exception<span class="token punctuation">(</span><span class="token string">'Invalid value for output_mode: %s'</span> <span class="token operator">%</span>
                            self<span class="token punctuation">.</span>output_mode<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>observation_space <span class="token operator">=</span> gym<span class="token punctuation">.</span>spaces<span class="token punctuation">.</span>Dict<span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token string">'history'</span><span class="token punctuation">:</span> gym<span class="token punctuation">.</span>spaces<span class="token punctuation">.</span>Box<span class="token punctuation">(</span>
                <span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span>
                <span class="token number">20</span> <span class="token keyword keyword-if">if</span> scale <span class="token keyword keyword-else">else</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token comment"># if scale=True observed price changes return could be large fractions</span>
                obs_shape
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'weights'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>action_space
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">step</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Step the env.

        Actions should be portfolio [w0...]
        - Where wn is a portfolio weight between 0 and 1. The first (w0) is cash_bias
        - cn is the portfolio conversion weights see PortioSim._step for description
        """</span>
        logger<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">'action: %s'</span><span class="token punctuation">,</span> action<span class="token punctuation">)</span>

        weights <span class="token operator">=</span> np<span class="token punctuation">.</span>clip<span class="token punctuation">(</span>action<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span>
        weights <span class="token operator">/=</span> weights<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> eps

        <span class="token comment"># Sanity checks</span>
        <span class="token keyword keyword-assert">assert</span> self<span class="token punctuation">.</span>action_space<span class="token punctuation">.</span>contains<span class="token punctuation">(</span>
            action<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'action should be within %r but is %r'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>action_space<span class="token punctuation">,</span> action<span class="token punctuation">)</span>
        np<span class="token punctuation">.</span>testing<span class="token punctuation">.</span>assert_almost_equal<span class="token punctuation">(</span>
            np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>weights<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> err_msg<span class="token operator">=</span><span class="token string">'weights should sum to 1. action="%s"'</span> <span class="token operator">%</span> weights<span class="token punctuation">)</span>

        history<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> done1 <span class="token operator">=</span> self<span class="token punctuation">.</span>src<span class="token punctuation">.</span>_step<span class="token punctuation">(</span><span class="token punctuation">)</span>

        reward<span class="token punctuation">,</span> info<span class="token punctuation">,</span> done2 <span class="token operator">=</span> self<span class="token punctuation">.</span>sim<span class="token punctuation">.</span>_step<span class="token punctuation">(</span>weights<span class="token punctuation">,</span> y1<span class="token punctuation">)</span>

        <span class="token comment"># calculate return for buy and hold a bit of each asset</span>
        info<span class="token punctuation">[</span><span class="token string">'market_value'</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>cumprod<span class="token punctuation">(</span>
            <span class="token punctuation">[</span>inf<span class="token punctuation">[</span><span class="token string">"market_return"</span><span class="token punctuation">]</span> <span class="token keyword keyword-for">for</span> inf <span class="token keyword keyword-in">in</span> self<span class="token punctuation">.</span>infos <span class="token operator">+</span> <span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token comment"># add dates</span>
        info<span class="token punctuation">[</span><span class="token string">'date'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>src<span class="token punctuation">.</span>times<span class="token punctuation">[</span>self<span class="token punctuation">.</span>src<span class="token punctuation">.</span>step<span class="token punctuation">]</span><span class="token punctuation">.</span>timestamp<span class="token punctuation">(</span><span class="token punctuation">)</span>
        info<span class="token punctuation">[</span><span class="token string">'steps'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>src<span class="token punctuation">.</span>step

        self<span class="token punctuation">.</span>infos<span class="token punctuation">.</span>append<span class="token punctuation">(</span>info<span class="token punctuation">)</span>

        <span class="token comment"># reshape history according to output mode</span>
        <span class="token keyword keyword-if">if</span> self<span class="token punctuation">.</span>output_mode <span class="token operator">==</span> <span class="token string">'EIIE'</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-pass">pass</span>
        <span class="token keyword keyword-if">if</span> done1 <span class="token keyword keyword-or">or</span> done2<span class="token punctuation">:</span>
            <span class="token comment">#output info file txt</span>
            <span class="token keyword keyword-with">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>log_dir <span class="token operator">+</span> <span class="token string">'/info.txt'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> f<span class="token punctuation">:</span>
                <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>infos<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token operator">=</span>f<span class="token punctuation">)</span>
            
        <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span><span class="token string">'history'</span><span class="token punctuation">:</span> history<span class="token punctuation">,</span> <span class="token string">'weights'</span><span class="token punctuation">:</span> weights<span class="token punctuation">}</span><span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done1 <span class="token keyword keyword-or">or</span> done2<span class="token punctuation">,</span> info   

    <span class="token keyword keyword-def">def</span> <span class="token function">reset</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>sim<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>src<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>infos <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        action <span class="token operator">=</span> self<span class="token punctuation">.</span>sim<span class="token punctuation">.</span>w0
        observation<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done<span class="token punctuation">,</span> info <span class="token operator">=</span> self<span class="token punctuation">.</span>step<span class="token punctuation">(</span>action<span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> observation

    <span class="token keyword keyword-def">def</span> <span class="token function">_seed</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> seed<span class="token punctuation">)</span><span class="token punctuation">:</span>
        np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span>seed<span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> <span class="token punctuation">[</span>seed<span class="token punctuation">]</span>


    <span class="token keyword keyword-def">def</span> <span class="token function">_render</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'notebook'</span><span class="token punctuation">,</span> close<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># if close:</span>
            <span class="token comment"># return</span>
        <span class="token keyword keyword-if">if</span> mode <span class="token operator">==</span> <span class="token string">'ansi'</span><span class="token punctuation">:</span>
            pprint<span class="token punctuation">(</span>self<span class="token punctuation">.</span>infos<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-elif">elif</span> mode <span class="token operator">==</span> <span class="token string">'notebook'</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>plot_notebook<span class="token punctuation">(</span>close<span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">plot_notebook</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> close<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Live plot using the jupyter notebook rendering of matplotlib."""</span>

        <span class="token keyword keyword-if">if</span> close<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_plot <span class="token operator">=</span> self<span class="token punctuation">.</span>_plot2 <span class="token operator">=</span> self<span class="token punctuation">.</span>_plot3 <span class="token operator">=</span> self<span class="token punctuation">.</span>_plot4<span class="token operator">=</span><span class="token boolean">None</span>
            <span class="token keyword keyword-return">return</span>

        df_info <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>self<span class="token punctuation">.</span>infos<span class="token punctuation">)</span>
        df_info<span class="token punctuation">.</span>index <span class="token operator">=</span> pd<span class="token punctuation">.</span>to_datetime<span class="token punctuation">(</span>df_info<span class="token punctuation">[</span><span class="token string">"date"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> unit<span class="token operator">=</span><span class="token string">'s'</span><span class="token punctuation">)</span>

        <span class="token comment"># plot prices and performance</span>
        all_assets <span class="token operator">=</span>  self<span class="token punctuation">.</span>sim<span class="token punctuation">.</span>asset_names
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> self<span class="token punctuation">.</span>_plot<span class="token punctuation">:</span>
            colors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>all_assets<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token string">'black'</span><span class="token punctuation">]</span>
            self<span class="token punctuation">.</span>_plot_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>
                self<span class="token punctuation">.</span>log_dir<span class="token punctuation">,</span> <span class="token string">'notebook_plot_prices_'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-if">if</span> self<span class="token punctuation">.</span>log_dir <span class="token keyword keyword-else">else</span> <span class="token boolean">None</span>
            self<span class="token punctuation">.</span>_plot <span class="token operator">=</span> LivePlotNotebook<span class="token punctuation">(</span>
                log_dir<span class="token operator">=</span>self<span class="token punctuation">.</span>_plot_dir<span class="token punctuation">,</span> title<span class="token operator">=</span><span class="token string">'prices &amp; performance'</span><span class="token punctuation">,</span> labels<span class="token operator">=</span>all_assets <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token string">"Portfolio"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ylabel<span class="token operator">=</span><span class="token string">'value'</span><span class="token punctuation">,</span> colors<span class="token operator">=</span>colors<span class="token punctuation">)</span>
        x <span class="token operator">=</span> df_info<span class="token punctuation">.</span>index
        y_portfolio <span class="token operator">=</span> df_info<span class="token punctuation">[</span><span class="token string">"portfolio_value"</span><span class="token punctuation">]</span>
        y_assets <span class="token operator">=</span> <span class="token punctuation">[</span>df_info<span class="token punctuation">[</span><span class="token string">'price_'</span> <span class="token operator">+</span> name<span class="token punctuation">]</span><span class="token punctuation">.</span>cumprod<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token keyword keyword-for">for</span> name <span class="token keyword keyword-in">in</span> all_assets<span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>_plot<span class="token punctuation">.</span>update<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y_assets <span class="token operator">+</span> <span class="token punctuation">[</span>y_portfolio<span class="token punctuation">]</span><span class="token punctuation">)</span>


        <span class="token comment"># plot portfolio weights</span>
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> self<span class="token punctuation">.</span>_plot2<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_plot_dir2 <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>
                self<span class="token punctuation">.</span>log_dir<span class="token punctuation">,</span> <span class="token string">'notebook_plot_weights_'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-if">if</span> self<span class="token punctuation">.</span>log_dir <span class="token keyword keyword-else">else</span> <span class="token boolean">None</span>
            self<span class="token punctuation">.</span>_plot2 <span class="token operator">=</span> LivePlotNotebook<span class="token punctuation">(</span>
                log_dir<span class="token operator">=</span>self<span class="token punctuation">.</span>_plot_dir2<span class="token punctuation">,</span> labels<span class="token operator">=</span>all_assets<span class="token punctuation">,</span> title<span class="token operator">=</span><span class="token string">'weights'</span><span class="token punctuation">,</span> ylabel<span class="token operator">=</span><span class="token string">'weight'</span><span class="token punctuation">)</span>
        ys <span class="token operator">=</span> <span class="token punctuation">[</span>df_info<span class="token punctuation">[</span><span class="token string">'weight_'</span> <span class="token operator">+</span> name<span class="token punctuation">]</span> <span class="token keyword keyword-for">for</span> name <span class="token keyword keyword-in">in</span> all_assets<span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>_plot2<span class="token punctuation">.</span>update<span class="token punctuation">(</span>x<span class="token punctuation">,</span> ys<span class="token punctuation">)</span>

        <span class="token comment"># plot portfolio costs</span>
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> self<span class="token punctuation">.</span>_plot3<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_plot_dir3 <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>
                self<span class="token punctuation">.</span>log_dir<span class="token punctuation">,</span> <span class="token string">'notebook_plot_cost_'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-if">if</span> self<span class="token punctuation">.</span>log_dir <span class="token keyword keyword-else">else</span> <span class="token boolean">None</span>
            self<span class="token punctuation">.</span>_plot3 <span class="token operator">=</span> LivePlotNotebook<span class="token punctuation">(</span>
                log_dir<span class="token operator">=</span>self<span class="token punctuation">.</span>_plot_dir3<span class="token punctuation">,</span> labels<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'cost'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> title<span class="token operator">=</span><span class="token string">'costs'</span><span class="token punctuation">,</span> ylabel<span class="token operator">=</span><span class="token string">'cost'</span><span class="token punctuation">)</span>
        ys <span class="token operator">=</span> <span class="token punctuation">[</span>df_info<span class="token punctuation">[</span><span class="token string">'cost'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cumsum<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>_plot3<span class="token punctuation">.</span>update<span class="token punctuation">(</span>x<span class="token punctuation">,</span> ys<span class="token punctuation">)</span>

        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> self<span class="token punctuation">.</span>_plot4<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_plot_dir4 <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>
                self<span class="token punctuation">.</span>log_dir<span class="token punctuation">,</span> <span class="token string">'notebook_plot_portfolio_'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-if">if</span> self<span class="token punctuation">.</span>log_dir <span class="token keyword keyword-else">else</span> <span class="token boolean">None</span>
            self<span class="token punctuation">.</span>_plot4 <span class="token operator">=</span> LivePlotNotebook<span class="token punctuation">(</span>
                log_dir<span class="token operator">=</span>self<span class="token punctuation">.</span>_plot_dir4<span class="token punctuation">,</span>labels<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'portfolio'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> title<span class="token operator">=</span><span class="token string">'portfolio'</span><span class="token punctuation">,</span> ylabel<span class="token operator">=</span><span class="token string">'value'</span><span class="token punctuation">)</span>
            x<span class="token operator">=</span> df_info<span class="token punctuation">.</span>index
            y<span class="token operator">=</span> df_info<span class="token punctuation">[</span><span class="token string">"portfolio_value"</span><span class="token punctuation">]</span>
            self<span class="token punctuation">.</span>_plot4<span class="token punctuation">.</span>update<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> close<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_plot <span class="token operator">=</span> self<span class="token punctuation">.</span>_plot2 <span class="token operator">=</span> self<span class="token punctuation">.</span>_plot3 <span class="token operator">=</span>self<span class="token punctuation">.</span>_plot4<span class="token operator">=</span> <span class="token boolean">None</span>
</code></pre><p>this class extends a gym environment.</p>
<p>the init function takes the data, number of steps,history length and other parameters. then calls for the reset function.</p>
<p>the reset function resets the previous two classes and returns the first observation.</p>
<p>the step function takes the action, checks if it is valid, then calls for the _step function of the data provider, having an observation and an action it then calls for the _step function of the portfolio simulator, then returns the observation, reward, done and info.</p>
<h2 id="part-two-creating-the-agent">Part Two: Creating the agent. </h2>
<h3 id="a-wrapping-the-environment">a) wrapping the environment </h3>
<p>since the agent takes a single input and returns a single output, we need to wrap the environment to make it compatible with the agent.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">concat_states</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>
    history <span class="token operator">=</span> state<span class="token punctuation">[</span><span class="token string">"history"</span><span class="token punctuation">]</span>
    weights <span class="token operator">=</span> state<span class="token punctuation">[</span><span class="token string">"weights"</span><span class="token punctuation">]</span>
    weight_insert_shape <span class="token operator">=</span> <span class="token punctuation">(</span>history<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> history<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-if">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>weights<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">==</span> history<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        weight_insert <span class="token operator">=</span> np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span>
            weight_insert_shape<span class="token punctuation">)</span> <span class="token operator">*</span> weights<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>newaxis<span class="token punctuation">,</span> np<span class="token punctuation">.</span>newaxis<span class="token punctuation">]</span>
    <span class="token keyword keyword-elif">elif</span> <span class="token builtin">len</span><span class="token punctuation">(</span>weights<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">==</span> history<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        weight_insert <span class="token operator">=</span> np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span>
            weight_insert_shape<span class="token punctuation">)</span> <span class="token operator">*</span> weights<span class="token punctuation">[</span>np<span class="token punctuation">.</span>newaxis<span class="token punctuation">,</span> np<span class="token punctuation">.</span>newaxis<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
    <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
        weight_insert <span class="token operator">=</span> np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span>
            weight_insert_shape<span class="token punctuation">)</span> <span class="token operator">*</span> weights<span class="token punctuation">[</span>np<span class="token punctuation">.</span>newaxis<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>newaxis<span class="token punctuation">]</span>
    state <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>weight_insert<span class="token punctuation">,</span> history<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> state


<span class="token keyword keyword-class">class</span> <span class="token class-name">ConcatStates</span><span class="token punctuation">(</span>gym<span class="token punctuation">.</span>Wrapper<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Concat both state arrays for models that take a single inputs.

    Usage:
        env = ConcatStates(env)

    """</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> env<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>env<span class="token punctuation">)</span>
        hist_space <span class="token operator">=</span> self<span class="token punctuation">.</span>observation_space<span class="token punctuation">.</span>spaces<span class="token punctuation">[</span><span class="token string">"history"</span><span class="token punctuation">]</span>
        hist_shape <span class="token operator">=</span> hist_space<span class="token punctuation">.</span>shape
        self<span class="token punctuation">.</span>observation_space <span class="token operator">=</span> gym<span class="token punctuation">.</span>spaces<span class="token punctuation">.</span>Box<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> shape<span class="token operator">=</span><span class="token punctuation">(</span>
            hist_shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> hist_shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> hist_shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">step</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">:</span>

        state<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done<span class="token punctuation">,</span> info <span class="token operator">=</span> self<span class="token punctuation">.</span>env<span class="token punctuation">.</span>step<span class="token punctuation">(</span>action<span class="token punctuation">)</span>

        <span class="token comment"># concat the two state arrays, since some models only take a single output</span>
        state <span class="token operator">=</span> concat_states<span class="token punctuation">(</span>state<span class="token punctuation">)</span>

        <span class="token keyword keyword-return">return</span> state<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done<span class="token punctuation">,</span> info

    <span class="token keyword keyword-def">def</span> <span class="token function">reset</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>env<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
        state <span class="token operator">=</span> self<span class="token punctuation">.</span>env<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> concat_states<span class="token punctuation">(</span>state<span class="token punctuation">)</span>
</code></pre><p>the concat_states function takes the observation and returns a single matrix containing the history and the weights.</p>
<h3 id="b-creating-the-policy-network-for-the-agent">b) creating the policy network for the agent </h3>
<p>the policy network is a neural network that will be used by the agent to predict the action.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">DepthCNN</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> channels<span class="token punctuation">,</span> ratio<span class="token operator">=</span><span class="token number">16</span> <span class="token punctuation">,</span>bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>num_assets<span class="token operator">=</span><span class="token number">13</span><span class="token punctuation">,</span>hist_len<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>cash_bias_int<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>device<span class="token operator">=</span><span class="token string">'cpu'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>DepthCNN<span class="token punctuation">,</span>self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>channels <span class="token operator">=</span> channels
        self<span class="token punctuation">.</span>convs1x1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>channels<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>convs1x5 <span class="token operator">=</span> nn<span class="token punctuation">.</span>ModuleList<span class="token punctuation">(</span><span class="token punctuation">[</span>nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> _ <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>convs5x1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>ModuleList<span class="token punctuation">(</span><span class="token punctuation">[</span>nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> _ <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>ratio <span class="token operator">=</span> ratio
        self<span class="token punctuation">.</span>Cdense1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">12</span> <span class="token operator">*</span> ratio<span class="token punctuation">,</span> bias<span class="token operator">=</span>bias<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>Cdense2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">12</span> <span class="token operator">*</span> ratio<span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span> bias<span class="token operator">=</span>bias<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>Hdense1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>num_assets<span class="token punctuation">,</span> num_assets <span class="token operator">*</span> ratio<span class="token punctuation">,</span> bias<span class="token operator">=</span>bias<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>Hdense2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>num_assets <span class="token operator">*</span> ratio<span class="token punctuation">,</span> num_assets<span class="token punctuation">,</span> bias<span class="token operator">=</span>bias<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>Wdense1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>hist_len<span class="token punctuation">,</span> hist_len <span class="token operator">*</span> ratio<span class="token punctuation">,</span> bias<span class="token operator">=</span>bias<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>Wdense2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>hist_len <span class="token operator">*</span> ratio<span class="token punctuation">,</span> hist_len<span class="token punctuation">,</span> bias<span class="token operator">=</span>bias<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>convs1x1two <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cash_bias_int <span class="token operator">=</span> cash_bias_int 
        self<span class="token punctuation">.</span>device <span class="token operator">=</span> device
    <span class="token keyword keyword-def">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>inputs<span class="token punctuation">,</span>ifstates<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        cash_bias <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>self<span class="token punctuation">.</span>cash_bias_int<span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>ifstates<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>       
        w0 <span class="token operator">=</span> inputs<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span> 
        inputs<span class="token operator">=</span>inputs<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>convs1x1<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>
        x <span class="token operator">=</span> torch<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        output_channels <span class="token operator">=</span> np<span class="token punctuation">.</span>split<span class="token punctuation">(</span>x<span class="token punctuation">,</span>x<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        out <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword keyword-for">for</span> i <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            layer <span class="token operator">=</span> self<span class="token punctuation">.</span>convs1x5<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>output_channels<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
            out<span class="token punctuation">.</span>append<span class="token punctuation">(</span>layer<span class="token punctuation">)</span>
            layer <span class="token operator">=</span> self<span class="token punctuation">.</span>convs5x1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>output_channels<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
            out<span class="token punctuation">.</span>append<span class="token punctuation">(</span>layer<span class="token punctuation">)</span>
        concatenated <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>out<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> h<span class="token punctuation">,</span> w <span class="token operator">=</span> concatenated<span class="token punctuation">.</span>shape
        C <span class="token operator">=</span> torch<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>concatenated<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        C <span class="token operator">=</span> self<span class="token punctuation">.</span>Cdense1<span class="token punctuation">(</span>C<span class="token punctuation">)</span>
        C<span class="token operator">=</span> torch<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>C<span class="token punctuation">)</span>
        C <span class="token operator">=</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>self<span class="token punctuation">.</span>Cdense2<span class="token punctuation">(</span>C<span class="token punctuation">)</span><span class="token punctuation">)</span>
        C <span class="token operator">=</span> C<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>c<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        W<span class="token operator">=</span> torch<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>concatenated<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        W <span class="token operator">=</span> self<span class="token punctuation">.</span>Wdense1<span class="token punctuation">(</span>W<span class="token punctuation">)</span>
        W<span class="token operator">=</span> torch<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>W<span class="token punctuation">)</span>
        W <span class="token operator">=</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>self<span class="token punctuation">.</span>Wdense2<span class="token punctuation">(</span>W<span class="token punctuation">)</span><span class="token punctuation">)</span>
        W <span class="token operator">=</span> W<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> w<span class="token punctuation">)</span>
        H <span class="token operator">=</span> torch<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>concatenated<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        H <span class="token operator">=</span> self<span class="token punctuation">.</span>Hdense1<span class="token punctuation">(</span>H<span class="token punctuation">)</span>
        H<span class="token operator">=</span> torch<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>H<span class="token punctuation">)</span>
        H <span class="token operator">=</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>self<span class="token punctuation">.</span>Hdense2<span class="token punctuation">(</span>H<span class="token punctuation">)</span><span class="token punctuation">)</span>
        H <span class="token operator">=</span> H<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> h<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        concatenated <span class="token operator">=</span> concatenated <span class="token operator">*</span> <span class="token punctuation">(</span>C <span class="token operator">+</span> H <span class="token operator">+</span> W<span class="token punctuation">)</span>
        concatenated <span class="token operator">=</span> torch<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>concatenated<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>keepdim<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        concatenated <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>concatenated<span class="token punctuation">,</span> w0<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        concatenated <span class="token operator">=</span> self<span class="token punctuation">.</span>convs1x1two<span class="token punctuation">(</span>concatenated<span class="token punctuation">)</span>
        concatenated <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>cash_bias<span class="token punctuation">,</span> concatenated<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        concatenated <span class="token operator">=</span> torch<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>concatenated<span class="token punctuation">)</span>
        concatenated <span class="token operator">=</span> concatenated<span class="token punctuation">.</span>view<span class="token punctuation">(</span>ifstates<span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">)</span>
        concatenated <span class="token operator">=</span> torch<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>concatenated<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> concatenated
</code></pre><p>the init function takes parameters such as number of assets and defines the layers of the network.</p>
<p>the forward function takes the observation which is a 3D matrix then runs it through the following network:<br>
<img src="readme_images%5Ccnnarch.png" alt="self.data"></p>
<blockquote>
<p>this image shows the architecture of the network used from input to output.</p>
</blockquote>
<h3 id="c-creating-the-agent">c) creating the agent </h3>
<p>the agent is a class that will be used to train the policy network.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">compute_returns</span><span class="token punctuation">(</span>rewards<span class="token punctuation">,</span> gamma<span class="token punctuation">)</span><span class="token punctuation">:</span>
    returns <span class="token operator">=</span> <span class="token number">0</span>
    R <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword keyword-for">for</span> r <span class="token keyword keyword-in">in</span> <span class="token builtin">reversed</span><span class="token punctuation">(</span>rewards<span class="token punctuation">)</span><span class="token punctuation">:</span>
        R <span class="token operator">=</span> r <span class="token operator">+</span> gamma <span class="token operator">*</span> R
    returns<span class="token operator">=</span>R
    <span class="token keyword keyword-return">return</span> returns
<span class="token keyword keyword-def">def</span> <span class="token function">train</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> policy<span class="token punctuation">,</span> optimizer<span class="token punctuation">,</span> gamma<span class="token punctuation">,</span> num_episodes<span class="token punctuation">)</span><span class="token punctuation">:</span>
    obs_dim <span class="token operator">=</span> env<span class="token punctuation">.</span>observation_space<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    action_dim <span class="token operator">=</span> env<span class="token punctuation">.</span>action_space<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    latest_checkpoint <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>glob<span class="token punctuation">.</span>glob<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"checkpoints/checkpoint_*.pt"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token operator">=</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>getctime<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-if">if</span> latest_checkpoint <span class="token keyword keyword-is">is</span> <span class="token keyword keyword-not">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Loading checkpoint: </span><span class="token interpolation"><span class="token punctuation">{</span>latest_checkpoint<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        policy<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>latest_checkpoint<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword keyword-for">for</span> i <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_episodes<span class="token punctuation">)</span><span class="token punctuation">:</span>
        state <span class="token operator">=</span> env<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
        done <span class="token operator">=</span> <span class="token boolean">False</span>
        rewards <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        
        <span class="token keyword keyword-while">while</span> <span class="token keyword keyword-not">not</span> done<span class="token punctuation">:</span>
            action <span class="token operator">=</span> policy<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            state<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done<span class="token punctuation">,</span> _ <span class="token operator">=</span> env<span class="token punctuation">.</span>step<span class="token punctuation">(</span>action<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            rewards<span class="token punctuation">.</span>append<span class="token punctuation">(</span>reward<span class="token punctuation">)</span>
            
        returns <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>compute_returns<span class="token punctuation">(</span>rewards<span class="token punctuation">,</span> gamma<span class="token punctuation">)</span><span class="token punctuation">,</span> requires_grad<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        loss <span class="token operator">=</span> <span class="token operator">-</span>returns
        
        optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
        loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
        optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment">#scheduler.step()  # Update the learning rate</span>

        
        <span class="token keyword keyword-if">if</span> i <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Episode </span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">, loss: </span><span class="token interpolation"><span class="token punctuation">{</span>loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> i <span class="token operator">%</span> <span class="token number">200</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token comment"># Save the model parameters to a file</span>
            checkpoint_path <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"checkpoints/checkpoint_</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">.pt"</span></span>
            torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>policy<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> checkpoint_path<span class="token punctuation">)</span>
        <span class="token comment"># Define the checkpoint directory</span>

<span class="token comment">#scheduler = lr_scheduler.StepLR(torch.optim.Adam(policynet.parameters(), lr=0.01), step_size=1000, gamma=0.1)</span>
train<span class="token punctuation">(</span>env<span class="token punctuation">,</span> policynet<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>policynet<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
</code></pre><p>this is a vanilla policy gradient agent. it takes the environment, the policy network, the optimizer, the discount factor and the number of episodes. it generates an action using the policy network, then takes the reward and the next observation from the environment. it then calculates the return and the loss and updates the policy network.</p>

      </div>
      
      
    
    
    
    
    
    
  
    </body></html>